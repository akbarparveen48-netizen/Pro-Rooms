{% include 'header.html' %}

{% block connections %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/rooms.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/all.min.css">
{% endblock %}

{% block body %}
<div class="dashboard-container">
    <section class="welcome-section">
        <h1>Pro Rooms ðŸŽ‰</h1>
        <p>Discover and join exclusive student & professional groups.</p>
    </section>

    <div class="actions-bar">
        <div class="search-box">
            <input type="text" id="roomSearch" placeholder="Search by room name or description..." autocomplete="off">
            <span class="search-icon"><i class="fas fa-search"></i></span>
        </div>
        <button class="btn-create" onclick="openModal('createRoomModal')">
            <i class="fas fa-plus"></i> Create New Room
        </button>
    </div>

    <div class="rooms-grid" id="roomsGrid">
        {% for room in rooms %}
        <div class="room-card" data-id="{{ room.id }}" data-name="{{ room.name|lower }}" data-desc="{{ room.description|lower }}">
            <div class="room-name">{{ room.name }}</div>
            <p class="room-desc">{{ room.description or 'No description provided.' }}</p>
            <div class="room-footer">
                <span class="room-tag"><i class="fas fa-users"></i> Member</span>
                <button class="btn-join" onclick="prepareJoin({{ room.id }}, '{{ room.name }}')">
                    Join Room <i class="fab fa-whatsapp"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create Room Modal -->
<div id="createRoomModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create Pro Room</h2>
        </div>
        <form id="createRoomForm">
            <div class="form-group">
                <label>Room Name</label>
                <input type="text" name="name" placeholder="e.g. Python Developers India" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" placeholder="What is this room about?" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>WhatsApp Group Link</label>
                <input type="url" name="whatsapp_link" placeholder="https://chat.whatsapp.com/..." required>
            </div>
            <div class="form-group">
                <label>Access Password (6 Digits)</label>
                <input type="text" name="password" placeholder="e.g. 123456" maxlength="6" pattern="\d{6}" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('createRoomModal')">Cancel</button>
                <button type="submit" class="btn-create">Create Room</button>
            </div>
        </form>
    </div>
</div>

<!-- Join Room / Password Modal -->
<div id="joinRoomModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="joinRoomTitle">Enter Password</h2>
            <p style="color: var(--text-muted)">Please enter the 6-digit access code for this room.</p>
        </div>
        <div class="passcode-container" id="passcodeContainer">
            <input type="text" class="passcode-input" maxlength="1" oninput="moveFocus(this, 1)" onkeydown="backFocus(this, event)">
            <input type="text" class="passcode-input" maxlength="1" oninput="moveFocus(this, 2)" onkeydown="backFocus(this, event)">
            <input type="text" class="passcode-input" maxlength="1" oninput="moveFocus(this, 3)" onkeydown="backFocus(this, event)">
            <input type="text" class="passcode-input" maxlength="1" oninput="moveFocus(this, 4)" onkeydown="backFocus(this, event)">
            <input type="text" class="passcode-input" maxlength="1" oninput="moveFocus(this, 5)" onkeydown="backFocus(this, event)">
            <input type="text" class="passcode-input" maxlength="1" oninput="moveFocus(this, 6)" onkeydown="backFocus(this, event)">
        </div>
        <div id="joinMsg" style="margin-top: 20px; text-align: center; color: #ff4d4d; font-size: 0.9rem;"></div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeModal('joinRoomModal')">Cancel</button>
            <button type="button" class="btn-create" onclick="verifyAndJoin()">Verify & Join</button>
        </div>
    </div>
</div>

<script>
    let currentJoinRoomId = null;

    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        if(id === 'joinRoomModal') {
            resetPasscode();
        }
    }

    // Search Functionality
    document.getElementById('roomSearch').addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.room-card');
        
        cards.forEach(card => {
            const name = card.getAttribute('data-name');
            const desc = card.getAttribute('data-desc');
            if (name.includes(query) || desc.includes(query)) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    });

    // Create Room
    document.getElementById('createRoomForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        const response = await fetch('/api/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Failed to create room');
        }
    });

    // Prepare Join
    function prepareJoin(id, name) {
        currentJoinRoomId = id;
        document.getElementById('joinRoomTitle').textContent = `Join ${name}`;
        openModal('joinRoomModal');
        document.querySelector('.passcode-input').focus();
    }

    // Passcode logic
    function moveFocus(input, nextIndex) {
        if (input.value.length === 1 && nextIndex < 6) {
            document.querySelectorAll('.passcode-input')[nextIndex].focus();
        }
    }

    function backFocus(input, event) {
        if (event.key === "Backspace" && input.value.length === 0) {
            const inputs = document.querySelectorAll('.passcode-input');
            const currentIndex = Array.from(inputs).indexOf(input);
            if (currentIndex > 0) {
                inputs[currentIndex - 1].focus();
            }
        }
    }

    function resetPasscode() {
        const inputs = document.querySelectorAll('.passcode-input');
        inputs.forEach(input => input.value = '');
        document.getElementById('joinMsg').textContent = '';
    }

    async function verifyAndJoin() {
        const inputs = document.querySelectorAll('.passcode-input');
        let passcode = "";
        inputs.forEach(input => passcode += input.value);

        if (passcode.length < 6) {
            document.getElementById('joinMsg').textContent = 'Please enter all 6 digits';
            return;
        }

        const btn = document.querySelector('#joinRoomModal .btn-create');
        btn.disabled = true;
        btn.textContent = 'Verifying...';

        const response = await fetch('/api/rooms/join', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ room_id: currentJoinRoomId, password: passcode })
        });

        const result = await response.json();
        if (result.success) {
            window.open(result.link, '_blank');
            closeModal('joinRoomModal');
        } else {
            document.getElementById('joinMsg').textContent = result.error || 'Incorrect password';
            btn.disabled = false;
            btn.textContent = 'Verify & Join';
        }
    }

    // Close on click outside
    window.onclick = function(event) {
        if (event.target.className === 'modal-overlay') {
            event.target.style.display = 'none';
        }
    }
</script>
{% endblock %}